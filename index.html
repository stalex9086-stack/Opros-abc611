<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Онлайн голосование</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    const firebaseConfig = {
      apiKey: "AIzaSyBXa2ZCZ8QlSPqXZXWtiAbDJk9HpP4P5A0",
      authDomain: "opros-abc611-6e34a.firebaseapp.com",
      databaseURL: "https://opros-abc611-6e34a-default-rtdb.firebaseio.com",
      projectId: "opros-abc611-6e34a",
      storageBucket: "opros-abc611-6e34a.firebasestorage.app",
      messagingSenderId: "892292768205",
      appId: "1:892292768205:web:b0f3147df004a7ac48a484",
      measurementId: "G-2EQTN4TGBL"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let endTime = 0;
    function setThemes(themes) {
      const cont = document.getElementById("themes");
      cont.innerHTML = "";
      themes.forEach((theme, idx) => {
        let btn = document.createElement("button");
        btn.innerText = theme;
        btn.onclick = () => vote(idx);
        cont.appendChild(btn);
      });
    }

    function checkVoting() {
      if (Date.now() > endTime) {
        document.getElementById("themes").innerHTML = "<b>Время голосования истекло</b>";
      }
    }
    function vote(idx) {
      if (Date.now() > endTime) return alert("Время голосования истекло!");
      // Можно добавить защиту от повторов по localStorage
      get(ref(db, 'votes/' + idx)).then(snapshot => {
        let cnt = snapshot.exists() ? snapshot.val() : 0;
        set(ref(db, "votes/" + idx), cnt + 1);
      });
      localStorage.setItem("voted", "true");
      document.getElementById("themes").innerHTML = "Спасибо за голос!";
    }

    function renderResults() {
      const res = document.getElementById("results");
      get(ref(db, "votes")).then(snap => {
        let arr = snap.exists() ? snap.val() : [];
        let out = "";
        themes.forEach((t, i) => {
          out += `<div>${t}: ${arr[i] || 0}</div>`;
        });
        res.innerHTML = out;
      });
    }

    let themes = [];
    onValue(ref(db, "themes"), snap => {
      themes = snap.exists() ? snap.val() : [];
      setThemes(themes);
      renderResults();
    });

    onValue(ref(db, "endTime"), snap => {
      endTime = snap.exists() ? snap.val() : 0;
      checkVoting();
    });

    setInterval(renderResults, 3000);
  </script>
</head>
<body>
  <h2>Онлайн голосование</h2>
  <div id="themes"></div>
  <h2>Результаты</h2>
  <div id="results"></div>
</body>
</html>
