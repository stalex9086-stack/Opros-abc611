<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Администрирование голосования</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root {
      --color-bg-1: rgba(59, 130, 246, 0.08);
      --color-bg-2: rgba(245, 158, 11, 0.08);
      --color-bg-3: rgba(34, 197, 94, 0.08);
      --color-bg-4: rgba(239, 68, 68, 0.08);
      --color-bg-5: rgba(147, 51, 234, 0.08);
      --color-bg-6: rgba(249, 115, 22, 0.08);
      --color-accent-1: rgba(59, 130, 246, 1);
      --color-accent-2: rgba(245, 158, 11, 1);
      --color-accent-3: rgba(34, 197, 94, 1);
      --color-accent-4: rgba(239, 68, 68, 1);
      --color-accent-5: rgba(147, 51, 234, 1);
      --color-accent-6: rgba(249, 115, 22, 1);
      --color-background: #fcfcf9;
      --color-surface: #fffdfd;
      --color-text: #13343b;
      --color-text-secondary: #626c71;
      --color-primary: #21808d;
      --color-card-border: rgba(94, 82, 64, 0.12);
      --radius-base: 8px;
      --radius-lg: 12px;
      --font-family-base: 'Inter', 'Segoe UI', Arial, sans-serif;
    }
    body {
      font-family: var(--font-family-base);
      background: var(--color-background);
      color: var(--color-text);
      margin: 0;
      padding: 0;
      min-height:100vh;
    }
    .container {
      max-width: 890px;
      margin: 0 auto;
      padding: 24px;
    }
    h1 {
      font-size: 32px;
      font-weight: 600;
      text-align: center;
      margin-bottom: 12px;
      color: var(--color-text);
    }
    .panel {
      background: var(--color-surface);
      box-shadow: 0 2px 16px #e6e9ee75;
      border-radius: var(--radius-lg);
      padding: 32px 36px;
      max-width: 460px;
      margin: 36px auto 30px auto;
    }
    .themeRow {
      margin:10px 0;display:flex;align-items:center;gap:8px;
    }
    .themeInput {
      width:73%;padding:7px;font-size:1em;border-radius:var(--radius-base);border:1px solid var(--color-card-border);
      background:var(--color-bg-1);
    }
    .admin-btn {
      background: var(--color-accent-1);
      color: #fff;
      padding: 7px 16px;
      border: none;
      font-size: 1em;
      border-radius: var(--radius-base);
      cursor:pointer;
      min-width: 80px;
      margin-left: 8px;
    }
    .admin-btn:hover {background:var(--color-primary);}
    input[type=password]{padding:7px;font-size:1em;border-radius:var(--radius-base);border:1px solid var(--color-card-border);}
    .hidden{display:none;}
    .topics-grid {display: grid;grid-template-columns: repeat(auto-fit,minmax(230px,1fr));gap:20px;margin-bottom:28px;}
    .topic-card {
      background: var(--color-bg-1);
      border-radius: var(--radius-lg);
      padding: 18px 18px 16px 18px;
      font-size: 1.08em;
      min-height:70px;
      border: 2px solid var(--color-card-border);
      box-shadow: 0 2px 8px #b7bcc627;
      display:flex;align-items:center;justify-content:space-between;
    }
    .remove-btn {
      background: var(--color-accent-4); color:#fff;border:none;border-radius:var(--radius-base);padding:6px 13px;font-family:inherit;cursor:pointer;
    }
    .remove-btn:hover{background:var(--color-accent-1);}
    .add-btn {
      background: var(--color-accent-3);
      color: #fff;
      border: none;
      border-radius: var(--radius-base);
      padding: 8px 20px;
      font-size: .97em;
      cursor:pointer;
      margin-top: 10px;
    }
    .results-list {display: flex;flex-direction: column;gap: 16px;}
    .result-item {background:var(--color-surface);border: 1px solid var(--color-card-border);border-radius: var(--radius-lg);padding:18px 20px;}
    .progress-bar {height:10px;background:var(--color-card-border);border-radius:6px;overflow:hidden;margin-top:8px;}
    .bar-fill {height:100%;border-radius:6px;}
    .bar-fill1 {background:var(--color-accent-1);}
    .bar-fill2 {background:var(--color-accent-2);}
    .bar-fill3 {background:var(--color-accent-3);}
    .bar-fill4 {background:var(--color-accent-4);}
    .bar-fill5 {background:var(--color-accent-5);}
    .bar-fill6 {background:var(--color-accent-6);}
    .timer-panel{margin:20px 0;display:flex;align-items:center;gap:13px;}
    .reset-panel{text-align:right;margin-top:23px;}
    .reset-btn{background:var(--color-accent-4);color:#fff;border:none;border-radius:var(--radius-base);padding:10px 18px;font-size:1em;cursor:pointer;}
    .reset-btn:hover{background:#c81a1a;}
    @media(max-width:700px){.container{padding:10px;}.panel{padding:18px 6px;}}
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    const firebaseConfig = {
      apiKey: "AIzaSyBXa2ZCZ8QlSPqXZXWtiAbDJk9HpP4P5A0",
      authDomain: "opros-abc611-6e34a.firebaseapp.com",
      databaseURL: "https://opros-abc611-6e34a-default-rtdb.firebaseio.com",
      projectId: "opros-abc611-6e34a",
      storageBucket: "opros-abc611-6e34a.firebasestorage.app",
      messagingSenderId: "892292768205",
      appId: "1:892292768205:web:b0f3147df004a7ac48a484",
      measurementId: "G-2EQTN4TGBL"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let themes = [];
    let adminOk = false;

    window.checkPass = function() {
      if(document.getElementById('pass').value==="admin123"){
        document.getElementById('loginPanel').classList.add('hidden');
        document.getElementById('adminPanel').classList.remove('hidden');
        renderThemes(); listenResults(); loadTimer();
      }else alert('Пароль неверный!');
    }

    window.saveThemes = function() {
      const arr = [];
      document.querySelectorAll(".themeInput").forEach(el => arr.push(el.value.trim()));
      set(ref(db, "themes"), arr);
      setTimeout(()=>renderThemes(),600);
    }
    window.renderThemes = function() {
      get(ref(db, "themes")).then(snap => {
        themes = snap.exists() ? snap.val() : [];
        let grid = document.getElementById("topicsGrid");
        grid.innerHTML = "";
        themes.forEach((theme, idx) => {
          grid.innerHTML += `<div class="topic-card">
            <input value="${theme}" class="themeInput">
            <button class="remove-btn" onclick="removeTheme(${idx})">✖</button>
          </div>`;
        });
        grid.innerHTML += `<button class="add-btn" onclick="addTheme()">+ Добавить тему</button>`;
      });
    }
    window.addTheme = function() {
      let grid = document.getElementById("topicsGrid");
      grid.innerHTML += `<div class="topic-card"><input value="" class="themeInput"><button class="remove-btn" style="visibility:hidden" disabled>✖</button></div>`;
    }
    window.removeTheme = function(idx) {
      let arr = themes.slice(); arr.splice(idx,1);
      set(ref(db, "themes"), arr);
      setTimeout(()=>renderThemes(),500);
    }
    window.saveTimer = function() {
      let mins = Number(document.getElementById("timerMins").value);
      if(isNaN(mins)||mins<=0)return alert("Введите срок в минутах!");
      let ms = Date.now() + mins*60000;
      set(ref(db, "endTime"), ms);
      setTimeout(()=>loadTimer(),500);
    }
    window.loadTimer = function() {
      get(ref(db, "endTime")).then(snap => {
        let end = snap.exists() ? new Date(snap.val()) : "нет таймера";
        document.getElementById("timerStatus").textContent = "Текущий таймер: " + end;
      });
    }
    window.listenResults = function() {
      onValue(ref(db, "votes"), snap => {
        let arr = snap.exists() ? snap.val() : [];
        get(ref(db, "themes")).then(tSnap=>{
          let themesArr = tSnap.val() || [];
          let container = document.getElementById("resultsList");
          container.innerHTML = "";
          let total = 0;
          for(let i=0;i<themesArr.length;++i)total+=arr[i]||0;
          for(let i=0;i<themesArr.length;++i){
            let val = arr[i]||0, percent=total?Math.round(val*100/total):0;
            let barClass = "bar-fill"+((i%6)+1);
            container.innerHTML += `
              <div class="result-item">
                <div><strong>${themesArr[i]}</strong> — <span style="color:${percent>0?'var(--color-accent-'+((i%6)+1)+')':'#aaa'};font-weight:bold">${val} (${percent}%)</span></div>
                <div class="progress-bar"><div class="bar-fill ${barClass}" style="width:${percent||2}%"></div></div>
              </div>
            `;
          }
          let res = document.getElementById("totalVotes");
          res.textContent="Всего голосов: "+total;
        });
      });
    }
    window.resetVotes = function() {
      set(ref(db, "votes"), {});
    }
  </script>
</head>
<body>
  <div class="container">
    <h1>Администрирование голосования</h1>
    <div id="loginPanel" class="panel">
      <h2>Вход</h2>
      <input id="pass" type="password" placeholder="Пароль организатора">
      <button class="admin-btn" onclick="checkPass()">Войти</button>
    </div>
    <div id="adminPanel" class="panel hidden">
      <h3>Темы (редактировать)</h3>
      <div class="topics-grid" id="topicsGrid"></div>
      <button class="admin-btn" style="margin-top:14px" onclick="saveThemes()">Сохранить темы</button>
      <div class="timer-panel">
        <h3 style="margin:0;">Таймер (минут):</h3>
        <input type="number" id="timerMins" value="3">
        <button class="admin-btn" onclick="saveTimer()">Установить</button>
        <span id="timerStatus"></span>
      </div>
      <h3>Результаты</h3>
      <div class="results-list" id="resultsList"></div>
      <div id="totalVotes" style="margin-top:9px;color:#21808d;font-size:1em"></div>
      <div class="reset-panel">
        <button class="reset-btn" onclick="resetVotes()">Сбросить голоса</button>
      </div>
    </div>
  </div>
</body>
</html>
